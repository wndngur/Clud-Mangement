# 채팅 기능 알고리즘 및 원리 설명서

## 목차
1. [개요](#1-개요)
2. [시스템 구조](#2-시스템-구조)
3. [데이터베이스 설계](#3-데이터베이스-설계)
4. [핵심 알고리즘](#4-핵심-알고리즘)
5. [실시간 메시지 동기화](#5-실시간-메시지-동기화)
6. [푸시 알림 시스템](#6-푸시-알림-시스템)
7. [코드 흐름 분석](#7-코드-흐름-분석)
8. [주요 클래스 설명](#8-주요-클래스-설명)
9. [NS 차트 (순서도)](#9-ns-차트-순서도)

---

## 1. 개요

### 1.1 채팅 시스템이란?
채팅 시스템은 두 명 이상의 사용자가 **실시간**으로 메시지를 주고받을 수 있는 기능입니다.

```
┌────────────────────────────────────────────────────────────┐
│                    채팅 시스템의 핵심 원리                    │
├────────────────────────────────────────────────────────────┤
│                                                            │
│   사용자 A ───────→ [서버/DB] ───────→ 사용자 B            │
│      │                  ↑                  │               │
│      │                  │                  │               │
│      └──────── 메시지 저장 ────────────────┘               │
│                         │                                  │
│                    실시간 동기화                            │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 1.2 이 앱의 채팅 기능 특징
| 기능 | 설명 |
|------|------|
| 1:1 채팅 | 두 사용자 간의 개인 대화 |
| 실시간 동기화 | Firebase Firestore의 실시간 리스너 활용 |
| 메시지 수정/삭제 | 본인이 보낸 메시지 관리 가능 |
| 푸시 알림 | 새 메시지 도착 시 알림 표시 |
| 읽지 않은 메시지 뱃지 | 네비게이션 바에 알림 개수 표시 |
| 카카오톡 스타일 UI | 친숙한 사용자 경험 제공 |

### 1.3 사용된 기술 스택

```
┌─────────────────────────────────────────────────────────┐
│                     기술 스택 구조                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌────────────┐  │
│  │  Android    │    │  Firebase   │    │  Firebase  │  │
│  │    Java     │◄──►│  Firestore  │    │  Messaging │  │
│  │   (클라이언트) │    │   (데이터베이스) │    │  (푸시알림)  │  │
│  └─────────────┘    └─────────────┘    └────────────┘  │
│         │                  │                  │         │
│         └──────────────────┼──────────────────┘         │
│                            │                            │
│                    ┌───────────────┐                   │
│                    │ RecyclerView  │                   │
│                    │   + Adapter   │                   │
│                    │  (UI 표시)    │                   │
│                    └───────────────┘                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 시스템 구조

### 2.1 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        사용자 A                              │
│                    (Android 앱)                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ChatDetailActivity                                 │   │
│  │  ├─ 메시지 입력창 (EditText)                         │   │
│  │  ├─ 전송 버튼 (ImageButton)                         │   │
│  │  └─ 메시지 목록 (RecyclerView + ChatMessageAdapter) │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ ① 메시지 전송 (add)
                      │ ② 실시간 수신 (addSnapshotListener)
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                 Firebase Firestore                          │
│                   (클라우드 DB)                              │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  chatRooms (컬렉션)                                  │   │
│  │  ├── room_abc123 (문서)                             │   │
│  │  │   ├── participants: ["userA", "userB"]          │   │
│  │  │   ├── lastMessage: "안녕하세요"                  │   │
│  │  │   ├── lastMessageTime: 1701763200000            │   │
│  │  │   │                                              │   │
│  │  │   └── messages (서브컬렉션)                      │   │
│  │  │       ├── msg_001                               │   │
│  │  │       │   ├── senderId: "userA"                 │   │
│  │  │       │   ├── message: "안녕하세요"              │   │
│  │  │       │   └── timestamp: 1701763200000          │   │
│  │  │       │                                         │   │
│  │  │       └── msg_002                               │   │
│  │  │           ├── senderId: "userB"                 │   │
│  │  │           ├── message: "반갑습니다!"             │   │
│  │  │           └── timestamp: 1701763260000          │   │
│  │  │                                                 │   │
│  │  └── room_def456 (다른 채팅방)                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ ③ 실시간 동기화 (자동)
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                        사용자 B                              │
│                    (Android 앱)                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  새 메시지 자동 표시!                                │   │
│  │  + 푸시 알림 발생                                    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 주요 컴포넌트 관계도

```
┌──────────────────────────────────────────────────────────────────┐
│                        앱 컴포넌트 관계도                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────┐         ┌────────────────┐                  │
│  │  ChatActivity  │────────►│ ChatListActivity│                  │
│  │  (채팅방 목록)  │  "추가"  │ (대화상대 선택) │                  │
│  └───────┬────────┘         └────────────────┘                  │
│          │                                                       │
│          │ 채팅방 클릭                                            │
│          ▼                                                       │
│  ┌────────────────┐                                             │
│  │ChatDetailActivity│                                            │
│  │  (실제 대화)    │                                             │
│  └───────┬────────┘                                             │
│          │                                                       │
│          │ 사용                                                   │
│          ▼                                                       │
│  ┌────────────────┐    ┌──────────────────┐                     │
│  │ChatMessageAdapter│◄──│ ChatMessage.java │                     │
│  │ (메시지 표시)   │    │   (데이터 모델)   │                     │
│  └───────┬────────┘    └──────────────────┘                     │
│          │                                                       │
│          │ 데이터 요청                                            │
│          ▼                                                       │
│  ┌────────────────┐    ┌──────────────────┐                     │
│  │ FirebaseManager │◄──►│ Firebase Firestore│                    │
│  │ (DB 통신 담당)  │    │   (클라우드 DB)   │                     │
│  └────────────────┘    └──────────────────┘                     │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 2.3 주요 컴포넌트 설명

| 컴포넌트 | 역할 | 파일 위치 |
|---------|------|----------|
| ChatActivity | 채팅방 목록 화면 표시 | `activities/ChatActivity.java` |
| ChatDetailActivity | 실제 대화 화면, 메시지 송수신 | `activities/ChatDetailActivity.java` |
| ChatListActivity | 새 대화 상대 선택 화면 | `activities/ChatListActivity.java` |
| ChatMessageAdapter | 메시지 목록을 RecyclerView에 표시 | `adapters/ChatMessageAdapter.java` |
| ChatRoomAdapter | 채팅방 목록을 RecyclerView에 표시 | `adapters/ChatRoomAdapter.java` |
| ChatMessage | 메시지 데이터 모델 (DTO) | `models/ChatMessage.java` |
| ChatRoom | 채팅방 데이터 모델 (DTO) | `models/ChatRoom.java` |
| FirebaseManager | Firebase DB 통신 담당 (싱글톤) | `utils/FirebaseManager.java` |
| ChatNotificationManager | 푸시 알림 및 뱃지 관리 | `utils/ChatNotificationManager.java` |

---

## 3. 데이터베이스 설계

### 3.1 Firestore 컬렉션 구조

```
Firestore Database
│
└── chatRooms (컬렉션) ─────────────────────────────────────
    │
    ├── {chatRoomId_1} (문서) ─────────────────────────────
    │   │
    │   ├── chatRoomId: "room_abc123"      // 채팅방 ID
    │   ├── participants: ["userA", "userB"] // 참여자 배열
    │   ├── user1Id: "userA"               // 첫 번째 사용자 ID
    │   ├── user2Id: "userB"               // 두 번째 사용자 ID
    │   ├── user1Name: "김철수"             // 첫 번째 사용자 이름
    │   ├── user2Name: "이영희"             // 두 번째 사용자 이름
    │   ├── lastMessage: "내일 봐요"        // 마지막 메시지 내용
    │   ├── lastMessageTime: 1701763200000 // 마지막 메시지 시간
    │   ├── clubId: "club_xyz"             // 관련 동아리 ID
    │   ├── clubName: "코딩동아리"          // 관련 동아리 이름
    │   ├── createdAt: Timestamp           // 생성 시간
    │   │
    │   └── messages (서브컬렉션) ─────────────────────────
    │       │
    │       ├── {messageId_1} (문서)
    │       │   ├── senderId: "userA"
    │       │   ├── senderName: "김철수"
    │       │   ├── message: "안녕하세요!"
    │       │   ├── timestamp: 1701763100000
    │       │   ├── isRead: true
    │       │   └── edited: false
    │       │
    │       ├── {messageId_2} (문서)
    │       │   ├── senderId: "userB"
    │       │   ├── senderName: "이영희"
    │       │   ├── message: "반갑습니다!"
    │       │   ├── timestamp: 1701763150000
    │       │   ├── isRead: true
    │       │   └── edited: false
    │       │
    │       └── {messageId_3} (문서)
    │           └── ...
    │
    └── {chatRoomId_2} (문서)
        └── ...
```

### 3.2 채팅방 (ChatRoom) 필드 설명

| 필드명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| chatRoomId | String | 채팅방 고유 식별자 | "room_abc123" |
| participants | Array<String> | 참여자 ID 목록 (검색용) | ["userA", "userB"] |
| user1Id | String | 채팅방 생성자 ID | "userA" |
| user2Id | String | 상대방 ID | "userB" |
| user1Name | String | 채팅방 생성자 이름 | "김철수" |
| user2Name | String | 상대방 이름 | "이영희" |
| lastMessage | String | 마지막 메시지 (목록 미리보기용) | "내일 봐요" |
| lastMessageTime | Long | 마지막 메시지 시간 (밀리초) | 1701763200000 |
| clubId | String | 관련 동아리 ID | "club_xyz" |
| clubName | String | 관련 동아리 이름 | "코딩동아리" |
| createdAt | Timestamp | 채팅방 생성 시간 | Timestamp |

### 3.3 메시지 (ChatMessage) 필드 설명

| 필드명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| senderId | String | 보낸 사람 ID | "userA" |
| senderName | String | 보낸 사람 이름 | "김철수" |
| message | String | 메시지 내용 | "안녕하세요!" |
| timestamp | Long | 보낸 시간 (밀리초) | 1701763200000 |
| isRead | Boolean | 읽음 여부 | false |
| edited | Boolean | 수정 여부 | false |

### 3.4 설계 원리 및 이유

#### 왜 participants 배열을 사용하나요?

```
┌─────────────────────────────────────────────────────────────┐
│                  participants 배열의 역할                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  문제: "내가 참여한 채팅방을 어떻게 찾을까?"                  │
│                                                             │
│  해결: participants 배열 + arrayContains 쿼리               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  // 내가 참여한 모든 채팅방 찾기                      │   │
│  │  db.collection("chatRooms")                         │   │
│  │    .whereArrayContains("participants", myUserId)    │   │
│  │    .get()                                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  장점:                                                      │
│  ✓ 한 번의 쿼리로 내 채팅방 전체 조회 가능                   │
│  ✓ 인덱스가 자동 생성되어 검색이 빠름                        │
│  ✓ 나중에 그룹 채팅으로 확장하기 쉬움                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 왜 messages를 서브컬렉션으로 분리하나요?

```
┌─────────────────────────────────────────────────────────────┐
│              서브컬렉션 vs 배열 비교                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ 나쁜 설계 (배열로 저장):                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  chatRoom: {                                        │   │
│  │    messages: [                                      │   │
│  │      { message: "안녕", ... },                      │   │
│  │      { message: "반가워", ... },                    │   │
│  │      ... (수천 개의 메시지)                         │   │
│  │    ]                                                │   │
│  │  }                                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│  문제: 채팅방 정보만 읽어도 모든 메시지가 함께 로드됨         │
│        → 느림, 데이터 사용량 증가, 비용 증가                 │
│                                                             │
│  ✓ 좋은 설계 (서브컬렉션):                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  chatRooms/{roomId}           → 채팅방 정보만 로드   │   │
│  │  chatRooms/{roomId}/messages  → 필요할 때만 로드     │   │
│  └─────────────────────────────────────────────────────┘   │
│  장점: 채팅방 목록은 빠르게, 메시지는 선택적으로 로드         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 핵심 알고리즘

### 4.1 채팅방 생성/조회 알고리즘 (createOrGetChatRoom)

#### 알고리즘 설명

```
┌─────────────────────────────────────────────────────────────┐
│          채팅방 생성/조회 알고리즘 흐름도                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                      ┌─────────┐                           │
│                      │  시작   │                           │
│                      └────┬────┘                           │
│                           │                                │
│                           ▼                                │
│              ┌────────────────────────┐                    │
│              │ 나와 상대방이 모두 포함된│                    │
│              │  채팅방이 있는지 검색   │                    │
│              └───────────┬────────────┘                    │
│                          │                                 │
│              ┌───────────┴───────────┐                     │
│              │                       │                     │
│              ▼                       ▼                     │
│      ┌──────────────┐       ┌──────────────┐              │
│      │  채팅방 있음  │       │  채팅방 없음  │              │
│      └──────┬───────┘       └──────┬───────┘              │
│             │                      │                       │
│             ▼                      ▼                       │
│    ┌────────────────┐     ┌────────────────┐              │
│    │기존 채팅방 반환 │     │ 새 채팅방 생성  │              │
│    └────────┬───────┘     │                │              │
│             │             │ - UUID 생성    │              │
│             │             │ - participants │              │
│             │             │ - user1, user2 │              │
│             │             │ - Firestore 저장│              │
│             │             └────────┬───────┘              │
│             │                      │                       │
│             └──────────┬───────────┘                       │
│                        │                                   │
│                        ▼                                   │
│               ┌────────────────┐                          │
│               │  채팅방 반환   │                          │
│               └────────┬───────┘                          │
│                        │                                   │
│                        ▼                                   │
│                   ┌─────────┐                             │
│                   │  종료   │                             │
│                   └─────────┘                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 실제 코드 (FirebaseManager.java)

```java
/**
 * 채팅방 생성 또는 기존 채팅방 조회
 *
 * 원리:
 * 1. 내가 참여한 모든 채팅방을 검색
 * 2. 그 중에서 상대방도 포함된 채팅방이 있는지 확인
 * 3. 있으면 기존 채팅방 반환, 없으면 새로 생성
 */
public void createOrGetChatRoom(String partnerUserId,
                                 String partnerName,
                                 String partnerRole,
                                 String clubId,
                                 String clubName,
                                 ChatRoomCallback callback) {

    String currentUserId = getCurrentUserId();

    // 1단계: 내가 참여한 채팅방 검색
    db.collection("chatRooms")
        .whereArrayContains("participants", currentUserId)
        .get()
        .addOnSuccessListener(querySnapshot -> {

            // 2단계: 상대방도 포함된 채팅방 찾기
            for (DocumentSnapshot doc : querySnapshot.getDocuments()) {
                List<String> participants = (List<String>) doc.get("participants");

                if (participants != null && participants.contains(partnerUserId)) {
                    // 3A: 기존 채팅방 발견! → 반환
                    ChatRoom existingRoom = doc.toObject(ChatRoom.class);
                    callback.onSuccess(existingRoom);
                    return;
                }
            }

            // 3B: 기존 채팅방 없음 → 새로 생성
            createNewChatRoom(currentUserId, partnerUserId,
                              partnerName, partnerRole,
                              clubId, clubName, callback);
        })
        .addOnFailureListener(e -> callback.onFailure(e));
}
```

### 4.2 메시지 전송 알고리즘 (sendMessage)

#### 알고리즘 설명

```
┌─────────────────────────────────────────────────────────────┐
│               메시지 전송 알고리즘 흐름도                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                      ┌─────────┐                           │
│                      │  시작   │                           │
│                      └────┬────┘                           │
│                           │                                │
│                           ▼                                │
│              ┌────────────────────────┐                    │
│              │ 입력된 메시지 가져오기  │                    │
│              │ (EditText에서 추출)    │                    │
│              └───────────┬────────────┘                    │
│                          │                                 │
│                          ▼                                 │
│              ┌────────────────────────┐                    │
│              │   빈 문자열인가?       │                    │
│              └───────────┬────────────┘                    │
│                          │                                 │
│              ┌───────────┴───────────┐                     │
│              │ YES                   │ NO                  │
│              ▼                       ▼                     │
│      ┌──────────────┐       ┌──────────────┐              │
│      │   함수 종료   │       │입력창 비우기  │              │
│      │  (전송 안함)  │       │ (UX 향상)    │              │
│      └──────────────┘       └──────┬───────┘              │
│                                    │                       │
│                                    ▼                       │
│                       ┌────────────────────────┐          │
│                       │   메시지 데이터 생성    │          │
│                       │  - senderId            │          │
│                       │  - senderName          │          │
│                       │  - message             │          │
│                       │  - timestamp           │          │
│                       │  - isRead: false       │          │
│                       └───────────┬────────────┘          │
│                                   │                        │
│                                   ▼                        │
│                       ┌────────────────────────┐          │
│                       │  Firestore에 저장      │          │
│                       │ (messages 서브컬렉션)  │          │
│                       └───────────┬────────────┘          │
│                                   │                        │
│                                   ▼                        │
│                       ┌────────────────────────┐          │
│                       │  채팅방 정보 업데이트   │          │
│                       │  - lastMessage         │          │
│                       │  - lastMessageTime     │          │
│                       └───────────┬────────────┘          │
│                                   │                        │
│                                   ▼                        │
│                              ┌─────────┐                  │
│                              │  종료   │                  │
│                              └─────────┘                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 실제 코드 (ChatDetailActivity.java)

```java
/**
 * 메시지 전송
 *
 * 원리:
 * 1. 사용자 입력 검증 (빈 문자열 체크)
 * 2. 메시지 데이터 객체 생성
 * 3. Firestore의 messages 서브컬렉션에 추가
 * 4. 채팅방의 lastMessage, lastMessageTime 업데이트
 */
private void sendMessage() {
    // 1단계: 메시지 내용 가져오기
    String messageText = etMessage.getText().toString().trim();

    // 2단계: 빈 메시지 검증
    if (TextUtils.isEmpty(messageText)) {
        return; // 빈 메시지는 전송하지 않음
    }

    // 3단계: 입력창 비우기 (사용자가 바로 다음 메시지 입력 가능)
    etMessage.setText("");

    // 4단계: 메시지 데이터 생성
    Map<String, Object> messageData = new HashMap<>();
    messageData.put("senderId", currentUserId);      // 보낸 사람 ID
    messageData.put("senderName", currentUserName);  // 보낸 사람 이름
    messageData.put("message", messageText);         // 메시지 내용
    messageData.put("timestamp", System.currentTimeMillis()); // 현재 시간
    messageData.put("isRead", false);                // 아직 안 읽음

    // 5단계: Firestore에 메시지 저장
    firebaseManager.getDb()
        .collection("chatRooms")
        .document(chatRoomId)
        .collection("messages")  // 서브컬렉션
        .add(messageData)        // 새 문서 추가 (ID 자동 생성)
        .addOnSuccessListener(documentReference -> {
            // 6단계: 채팅방 마지막 메시지 정보 업데이트
            updateChatRoomLastMessage(messageText);
        });
}

/**
 * 채팅방의 마지막 메시지 정보 업데이트
 *
 * 목적: 채팅방 목록에서 마지막 메시지 미리보기 표시
 */
private void updateChatRoomLastMessage(String lastMessage) {
    Map<String, Object> updates = new HashMap<>();
    updates.put("lastMessage", lastMessage);
    updates.put("lastMessageTime", System.currentTimeMillis());

    firebaseManager.getDb()
        .collection("chatRooms")
        .document(chatRoomId)
        .update(updates);
}
```

### 4.3 메시지 정렬 알고리즘

```
┌─────────────────────────────────────────────────────────────┐
│                  메시지 정렬 원리                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  사용 쿼리:                                                 │
│  .orderBy("timestamp", Query.Direction.ASCENDING)           │
│                                                             │
│  원리: timestamp(밀리초)를 오름차순으로 정렬                  │
│                                                             │
│  정렬 전:                    정렬 후:                        │
│  ┌────────────────────┐     ┌────────────────────┐         │
│  │ msg3: 1701763300   │     │ msg1: 1701763100   │ ← 상단  │
│  │ msg1: 1701763100   │ ──► │ msg2: 1701763200   │         │
│  │ msg2: 1701763200   │     │ msg3: 1701763300   │ ← 하단  │
│  └────────────────────┘     └────────────────────┘         │
│                                                             │
│  화면 표시:                                                 │
│  ┌────────────────────────────────────┐                    │
│  │  오전 10:00  안녕하세요 (오래된 것) │  ← 상단            │
│  │  오전 10:05  반갑습니다            │                    │
│  │  오전 10:10  오늘 뭐해요?          │                    │
│  │  오전 10:15  동아리 활동! (최신)   │  ← 하단            │
│  └────────────────────────────────────┘                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 실시간 메시지 동기화

### 5.1 실시간 리스너 원리

```
┌─────────────────────────────────────────────────────────────┐
│           일반 방식 vs Firebase 실시간 리스너                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ 일반적인 방식 (Polling - 폴링):                          │
│                                                             │
│  ┌─────┐          시간          ┌─────────┐                │
│  │ 앱  │ ─────── 요청 ─────────→│  서버   │                │
│  │     │ ←────── 응답 ──────────│         │                │
│  │     │                        │         │                │
│  │     │  (5초 대기...)         │         │                │
│  │     │                        │         │                │
│  │     │ ─────── 요청 ─────────→│         │                │
│  │     │ ←────── 응답 ──────────│         │                │
│  │     │                        │         │                │
│  │     │  (5초 대기...)         │         │                │
│  │     │         :              │         │                │
│  └─────┘                        └─────────┘                │
│                                                             │
│  문제점:                                                    │
│  - 불필요한 요청이 많음 (변경 없어도 계속 요청)               │
│  - 실시간성 떨어짐 (최대 5초 지연)                           │
│  - 배터리/데이터 낭비                                        │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  ✓ Firebase 실시간 리스너 (Snapshot Listener):              │
│                                                             │
│  ┌─────┐                        ┌─────────┐                │
│  │ 앱  │ ─────── 구독 ─────────→│Firebase │                │
│  │     │         (1회)          │         │                │
│  │     │                        │         │                │
│  │     │  (서버에서 데이터 변경 발생)     │                 │
│  │     │                        │   변경! │                │
│  │     │ ←───── 자동 알림 ──────│    ↓    │                │
│  │     │                        │         │                │
│  │     │  (또 변경 발생)        │   변경! │                │
│  │     │ ←───── 자동 알림 ──────│    ↓    │                │
│  └─────┘                        └─────────┘                │
│                                                             │
│  장점:                                                      │
│  - 변경 시에만 알림 (효율적)                                 │
│  - 진정한 실시간 (지연 거의 없음)                            │
│  - 배터리/데이터 절약                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 실시간 리스너 구현

```java
/**
 * 메시지 실시간 리스너 등록
 *
 * 원리:
 * 1. addSnapshotListener로 컬렉션 구독
 * 2. 데이터 변경 시 자동으로 콜백 호출
 * 3. 콜백에서 UI 업데이트
 */
private void listenForMessages() {
    if (chatRoomId == null) return;

    // 실시간 리스너 등록
    messageListener = firebaseManager.getDb()
        .collection("chatRooms")
        .document(chatRoomId)
        .collection("messages")
        .orderBy("timestamp", Query.Direction.ASCENDING)  // 시간순 정렬
        .addSnapshotListener((querySnapshots, error) -> {
            // 에러 처리
            if (error != null || querySnapshots == null) return;

            // 메시지 목록 생성
            List<ChatMessage> messages = new ArrayList<>();
            for (DocumentSnapshot doc : querySnapshots.getDocuments()) {
                ChatMessage message = doc.toObject(ChatMessage.class);
                if (message != null) {
                    message.setMessageId(doc.getId());
                    messages.add(message);
                }
            }

            // UI 업데이트 (어댑터에 데이터 전달)
            adapter.setMessages(messages);

            // 최신 메시지로 스크롤
            if (!messages.isEmpty()) {
                rvMessages.scrollToPosition(messages.size() - 1);
            }
        });
}
```

### 5.3 리스너 생명주기 관리

```
┌─────────────────────────────────────────────────────────────┐
│                리스너 생명주기 관리                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  중요: 리스너는 반드시 해제해야 합니다!                      │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ChatDetailActivity 생명주기                        │   │
│  │                                                     │   │
│  │  onCreate()                                         │   │
│  │      │                                              │   │
│  │      └─→ listenForMessages() 호출                   │   │
│  │              │                                      │   │
│  │              └─→ messageListener = ... (리스너 등록)│   │
│  │                                                     │   │
│  │  [사용자가 채팅 화면 사용 중...]                     │   │
│  │                                                     │   │
│  │  onDestroy()                                        │   │
│  │      │                                              │   │
│  │      └─→ messageListener.remove() (리스너 해제)     │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  해제하지 않으면 발생하는 문제:                              │
│  ✗ 메모리 누수 (Memory Leak)                                │
│  ✗ 화면 종료 후에도 계속 데이터 수신                        │
│  ✗ 앱 성능 저하                                             │
│  ✗ 배터리 소모                                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```java
@Override
protected void onDestroy() {
    super.onDestroy();

    // 리스너 해제 (메모리 누수 방지)
    if (messageListener != null) {
        messageListener.remove();
        messageListener = null;
    }

    // 현재 열린 채팅방 해제
    getChatNotificationManager().clearCurrentOpenChatRoom();
}
```

---

## 6. 푸시 알림 시스템

### 6.1 알림 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│                   푸시 알림 시스템 구조                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  사용자 A (송신자)                   │   │
│  │                                                     │   │
│  │  "안녕하세요!" 전송                                 │   │
│  │         │                                           │   │
│  └─────────┼───────────────────────────────────────────┘   │
│            │                                               │
│            ▼                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               Firebase Firestore                    │   │
│  │                                                     │   │
│  │  chatRooms/{roomId}/messages에 저장                 │   │
│  │         │                                           │   │
│  └─────────┼───────────────────────────────────────────┘   │
│            │                                               │
│            │ 실시간 리스너가 감지                          │
│            ▼                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            ChatNotificationManager                  │   │
│  │                 (사용자 B의 앱)                      │   │
│  │                                                     │   │
│  │  1. 새 메시지 감지                                  │   │
│  │  2. 보낸 사람이 나인지 확인                         │   │
│  │  3. 현재 열린 채팅방인지 확인                       │   │
│  │  4. 조건 충족 시 → 알림 발송                        │   │
│  │                                                     │   │
│  └─────────┬───────────────────────────────────────────┘   │
│            │                                               │
│            ▼                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  사용자 B (수신자)                   │   │
│  │                                                     │   │
│  │  ┌───────────────────────────┐                     │   │
│  │  │  🔔 김철수                │  ← 푸시 알림        │   │
│  │  │  안녕하세요!              │                     │   │
│  │  └───────────────────────────┘                     │   │
│  │                                                     │   │
│  │  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐              │   │
│  │  │ 홈  │  │채팅 │  │동아리│  │내정보│              │   │
│  │  │     │  │ 🔴1 │  │     │  │     │  ← 뱃지      │   │
│  │  └─────┘  └─────┘  └─────┘  └─────┘              │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 알림 발생 조건

```
┌─────────────────────────────────────────────────────────────┐
│                    알림 발생 조건 판단                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    새 메시지 감지                            │
│                         │                                   │
│                         ▼                                   │
│            ┌──────────────────────────┐                    │
│            │ 내가 보낸 메시지인가?     │                    │
│            └────────────┬─────────────┘                    │
│                         │                                   │
│           ┌─────────────┴─────────────┐                    │
│           │ YES                       │ NO                 │
│           ▼                           ▼                    │
│    ┌──────────────┐         ┌──────────────────────┐       │
│    │ 알림 안 함   │         │현재 열린 채팅방인가? │       │
│    │ (내 메시지)  │         └──────────┬───────────┘       │
│    └──────────────┘                    │                   │
│                           ┌────────────┴────────────┐      │
│                           │ YES                     │ NO   │
│                           ▼                         ▼      │
│                  ┌──────────────┐        ┌──────────────┐  │
│                  │ 알림 안 함   │        │  알림 발송!  │  │
│                  │(이미 보고 있음)│        │ + 뱃지 증가 │  │
│                  └──────────────┘        └──────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 ChatNotificationManager 구현

```java
/**
 * 채팅 알림 관리자
 *
 * 역할:
 * 1. 새 메시지 실시간 감지
 * 2. 로컬 푸시 알림 발송
 * 3. 읽지 않은 메시지 카운트 관리 (뱃지)
 */
public class ChatNotificationManager {

    private String currentOpenChatRoomId = null;  // 현재 열린 채팅방
    private int unreadCount = 0;                   // 읽지 않은 메시지 수

    /**
     * 특정 채팅방의 새 메시지 감시
     */
    private void listenToChatRoom(String chatRoomId, String currentUserId) {
        firebaseManager.getDb()
            .collection("chatRooms")
            .document(chatRoomId)
            .collection("messages")
            .orderBy("timestamp", Query.Direction.DESCENDING)
            .limit(1)  // 가장 최근 메시지만
            .addSnapshotListener((snapshots, error) -> {
                if (error != null || snapshots == null) return;

                for (DocumentChange dc : snapshots.getDocumentChanges()) {
                    if (dc.getType() == DocumentChange.Type.ADDED) {
                        String senderId = dc.getDocument().getString("senderId");
                        String senderName = dc.getDocument().getString("senderName");
                        String message = dc.getDocument().getString("message");

                        // 조건 확인: 내가 보낸 게 아니고, 현재 열린 채팅방이 아닌 경우
                        if (senderId != null && !senderId.equals(currentUserId)) {
                            if (!chatRoomId.equals(currentOpenChatRoomId)) {
                                // 알림 발송!
                                showNotification(senderName, message, chatRoomId);
                                incrementUnreadCount();  // 뱃지 카운트 증가
                            }
                        }
                    }
                }
            });
    }
}
```

---

## 7. 코드 흐름 분석

### 7.1 채팅 시작부터 메시지 전송까지 전체 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                     전체 채팅 흐름도                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  사용자 행동                           시스템 동작                   │
│  ────────────                         ────────────                  │
│                                                                     │
│  1. 앱 실행 & 로그인                                               │
│        │                                                           │
│        └────────────────────────────→ MainActivityNew 시작          │
│                                       │                            │
│                                       └→ ChatNotificationManager    │
│                                          .startListening() 호출    │
│                                          (알림 리스너 시작)         │
│                                                                     │
│  2. 채팅 탭 클릭                                                    │
│        │                                                           │
│        └────────────────────────────→ ChatActivity 열림             │
│                                       │                            │
│                                       └→ getChatRooms() 호출        │
│                                          │                         │
│                                          └→ Firestore 쿼리:         │
│                                             whereArrayContains     │
│                                             ("participants", myId) │
│                                          │                         │
│                                          └→ 채팅방 목록 표시        │
│                                             (ChatRoomAdapter)      │
│                                                                     │
│  3. "추가" 버튼 클릭                                                │
│        │                                                           │
│        └────────────────────────────→ ChatListActivity 열림         │
│                                       │                            │
│                                       └→ 동아리 멤버 목록 표시      │
│                                                                     │
│  4. 대화 상대 선택                                                  │
│        │                                                           │
│        └────────────────────────────→ createOrGetChatRoom() 호출    │
│                                       │                            │
│                                       ├→ 기존 채팅방 검색           │
│                                       │                            │
│                                       └→ 없으면 새 채팅방 생성      │
│                                                                     │
│  5. 채팅방 클릭                                                     │
│        │                                                           │
│        └────────────────────────────→ ChatDetailActivity 열림       │
│                                       │                            │
│                                       ├→ listenForMessages() 호출   │
│                                       │  (실시간 리스너 등록)       │
│                                       │                            │
│                                       ├→ 기존 메시지 로드 & 표시    │
│                                       │                            │
│                                       └→ setCurrentOpenChatRoom()   │
│                                          (알림 방지 설정)           │
│                                                                     │
│  6. 메시지 입력 후 전송 버튼 클릭                                   │
│        │                                                           │
│        └────────────────────────────→ sendMessage() 호출            │
│                                       │                            │
│                                       ├→ 메시지 데이터 생성         │
│                                       │                            │
│                                       ├→ Firestore에 저장           │
│                                       │  (messages 서브컬렉션)      │
│                                       │                            │
│                                       └→ 채팅방 정보 업데이트        │
│                                          (lastMessage 등)          │
│                                                                     │
│  7. 메시지 표시 (실시간)                                            │
│        │                                                           │
│        └←─────────────────────────── 실시간 리스너가 변경 감지      │
│                                       │                            │
│                                       └→ adapter.setMessages()      │
│                                          (UI 자동 업데이트)         │
│                                                                     │
│  8. 상대방에게 알림 (동시에)                                        │
│                                                                     │
│        상대방 앱의 ChatNotificationManager가 새 메시지 감지          │
│                │                                                   │
│                ├→ 푸시 알림 표시                                    │
│                │                                                   │
│                └→ 네비게이션 뱃지 업데이트                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 메시지 수정/삭제 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                  메시지 수정/삭제 흐름도                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  메시지 롱클릭 (길게 누르기)                                 │
│        │                                                    │
│        ▼                                                    │
│  showMessageOptionsDialog() 호출                            │
│        │                                                    │
│        ├─────────────────────────────────────────────────┐  │
│        │              내 메시지인가?                      │  │
│        │                                                 │  │
│        ▼                                                 ▼  │
│  ┌──────────────┐                           ┌──────────────┐│
│  │  내 메시지   │                           │ 상대방 메시지 ││
│  │              │                           │              ││
│  │ [수정] [삭제]│                           │   [복사]     ││
│  └──────┬───────┘                           └──────┬───────┘│
│         │                                          │        │
│  ┌──────┴──────┐                                   │        │
│  │             │                                   │        │
│  ▼             ▼                                   ▼        │
│ "수정"      "삭제"                              "복사"      │
│  │             │                                   │        │
│  ▼             ▼                                   ▼        │
│ showEdit    showDelete                     copyToClipboard │
│ Dialog()   ConfirmDialog()                      ()         │
│  │             │                                   │        │
│  ▼             ▼                                   │        │
│ [EditText] [확인 다이얼로그]                       │        │
│  │         "정말 삭제?"                            │        │
│  │             │                                   │        │
│  ▼             ▼                                   │        │
│ updateMessage() deleteMessage()            Toast 표시      │
│  │             │                           "복사됨"        │
│  ▼             ▼                                            │
│ Firestore   Firestore                                      │
│ .update()   .delete()                                      │
│                                                             │
│  ↓ 실시간 리스너가 변경 감지                                │
│  ↓                                                          │
│  UI 자동 업데이트 (양쪽 모두)                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 주요 클래스 설명

### 8.1 데이터 모델 클래스

#### ChatMessage.java

```java
/**
 * 채팅 메시지 데이터 모델
 *
 * 역할: Firestore의 메시지 문서와 1:1 매핑되는 Java 객체
 * 패턴: DTO (Data Transfer Object)
 */
public class ChatMessage {
    private String messageId;    // 메시지 고유 ID (Firestore 문서 ID)
    private String senderId;     // 보낸 사람의 사용자 ID
    private String senderName;   // 보낸 사람의 이름 (표시용)
    private String message;      // 메시지 내용
    private long timestamp;      // 보낸 시간 (밀리초 단위 Unix 타임스탬프)
    private boolean isRead;      // 읽음 여부

    // 기본 생성자 (Firestore 역직렬화에 필요)
    public ChatMessage() {}

    // Getter/Setter 메서드들
    public String getMessageId() { return messageId; }
    public void setMessageId(String messageId) { this.messageId = messageId; }

    public String getSenderId() { return senderId; }
    public void setSenderId(String senderId) { this.senderId = senderId; }

    // ... 나머지 getter/setter
}
```

#### ChatRoom.java

```java
/**
 * 채팅방 데이터 모델
 *
 * 역할: Firestore의 채팅방 문서와 1:1 매핑되는 Java 객체
 */
public class ChatRoom {
    private String chatRoomId;           // 채팅방 고유 ID
    private List<String> participants;   // 참여자 ID 목록
    private String user1Id, user2Id;     // 참여자 ID
    private String user1Name, user2Name; // 참여자 이름
    private String lastMessage;          // 마지막 메시지 (미리보기용)
    private long lastMessageTime;        // 마지막 메시지 시간
    private String partnerName;          // 상대방 이름 (표시용)
    private String partnerUserId;        // 상대방 ID
    private String clubId, clubName;     // 관련 동아리 정보

    // ... getter/setter
}
```

### 8.2 어댑터 클래스

#### ChatMessageAdapter.java

```java
/**
 * 채팅 메시지 어댑터
 *
 * 역할: 메시지 데이터를 RecyclerView에 표시
 * 패턴: ViewHolder 패턴 (효율적인 뷰 재사용)
 */
public class ChatMessageAdapter extends RecyclerView.Adapter<MessageViewHolder> {

    private List<ChatMessage> messages = new ArrayList<>();
    private String currentUserId;  // 현재 로그인한 사용자 (내 메시지 구분용)

    /**
     * 메시지를 화면에 바인딩
     *
     * 핵심 로직: 내가 보낸 메시지 vs 받은 메시지 구분
     */
    @Override
    public void onBindViewHolder(MessageViewHolder holder, int position) {
        ChatMessage message = messages.get(position);

        // 내가 보낸 메시지인지 확인
        boolean isSent = message.getSenderId().equals(currentUserId);

        if (isSent) {
            // 내가 보낸 메시지: 오른쪽, 노란색 말풍선
            holder.layoutSent.setVisibility(View.VISIBLE);
            holder.layoutReceived.setVisibility(View.GONE);
            holder.tvMessageSent.setText(message.getMessage());
            holder.tvTimeSent.setText(formatTime(message.getTimestamp()));
        } else {
            // 받은 메시지: 왼쪽, 흰색 말풍선, 프로필 표시
            holder.layoutSent.setVisibility(View.GONE);
            holder.layoutReceived.setVisibility(View.VISIBLE);
            holder.tvMessageReceived.setText(message.getMessage());
            holder.tvTimeReceived.setText(formatTime(message.getTimestamp()));
            holder.tvSenderName.setText(message.getSenderName());
        }
    }

    /**
     * 시간 포맷팅 (밀리초 → "오전 10:30")
     */
    private String formatTime(long timestamp) {
        SimpleDateFormat sdf = new SimpleDateFormat("a h:mm", Locale.KOREA);
        return sdf.format(new Date(timestamp));
    }
}
```

### 8.3 관리자 클래스

#### FirebaseManager.java (싱글톤 패턴)

```java
/**
 * Firebase 통신 관리자
 *
 * 역할: 앱 전체에서 Firebase와의 모든 통신을 담당
 * 패턴: 싱글톤 (Singleton) - 앱 전체에서 하나의 인스턴스만 사용
 */
public class FirebaseManager {

    // 싱글톤 인스턴스
    private static FirebaseManager instance;

    // Firebase 인스턴스들
    private FirebaseFirestore db;
    private FirebaseAuth auth;

    // private 생성자 (외부에서 new 불가)
    private FirebaseManager() {
        db = FirebaseFirestore.getInstance();
        auth = FirebaseAuth.getInstance();
    }

    /**
     * 싱글톤 인스턴스 반환
     *
     * 원리: 인스턴스가 없으면 생성, 있으면 기존 것 반환
     */
    public static FirebaseManager getInstance() {
        if (instance == null) {
            instance = new FirebaseManager();
        }
        return instance;
    }

    // 채팅 관련 메서드들
    public void createOrGetChatRoom(...) { /* ... */ }
    public void getChatRooms(...) { /* ... */ }
    public void getClubMembers(...) { /* ... */ }
}
```

---

## 9. NS 차트 (순서도)

### 9.1 채팅방 생성 NS 차트

```
┌─────────────────────────────────────────────────────────────┐
│              createOrGetChatRoom(partnerUserId)             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ currentUserId = getCurrentUserId()                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Firestore에서 내가 참여한 채팅방 조회                │   │
│  │ (whereArrayContains("participants", currentUserId)) │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            각 채팅방에 대해 반복                     │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │  participants에 partnerUserId가 포함되어 있나? │  │   │
│  │  └───────────────────┬───────────────────────────┘  │   │
│  │           ┌──────────┴──────────┐                   │   │
│  │           │ YES                 │ NO                │   │
│  │           ▼                     ▼                   │   │
│  │  ┌─────────────────┐   ┌─────────────────┐         │   │
│  │  │ 기존 채팅방 반환 │   │  다음 채팅방    │         │   │
│  │  │ callback.onSuccess│   │  확인 (반복)   │         │   │
│  │  │ return           │   └─────────────────┘         │   │
│  │  └─────────────────┘                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼ (반복 끝, 찾지 못함)            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              새 채팅방 생성                          │   │
│  │  ┌───────────────────────────────────────────────┐  │   │
│  │  │ chatRoomId = UUID.randomUUID()                │  │   │
│  │  │ participants = [currentUserId, partnerUserId] │  │   │
│  │  │ createdAt = Timestamp.now()                   │  │   │
│  │  └───────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Firestore에 저장                                    │   │
│  │ db.collection("chatRooms").document(chatRoomId).set()│   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ callback.onSuccess(새 ChatRoom 반환)                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.2 메시지 전송 NS 차트

```
┌─────────────────────────────────────────────────────────────┐
│                      sendMessage()                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ messageText = etMessage.getText().toString().trim() │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │        messageText가 비어있는가?                     │   │
│  └───────────────────────┬─────────────────────────────┘   │
│           ┌──────────────┴──────────────┐                  │
│           │ YES                         │ NO               │
│           ▼                             ▼                  │
│  ┌─────────────────┐         ┌─────────────────────────┐   │
│  │  return (종료)  │         │ etMessage.setText("")   │   │
│  │  (빈 메시지는   │         │ (입력창 비우기)         │   │
│  │   전송 안 함)   │         └───────────┬─────────────┘   │
│  └─────────────────┘                     │                 │
│                                          ▼                 │
│                    ┌─────────────────────────────────────┐ │
│                    │         메시지 데이터 생성          │ │
│                    │  ┌─────────────────────────────┐   │ │
│                    │  │ Map messageData = new HashMap│   │ │
│                    │  │ - senderId: currentUserId    │   │ │
│                    │  │ - senderName: currentUserName│   │ │
│                    │  │ - message: messageText       │   │ │
│                    │  │ - timestamp: 현재시간(밀리초)│   │ │
│                    │  │ - isRead: false              │   │ │
│                    │  └─────────────────────────────┘   │ │
│                    └─────────────────┬───────────────────┘ │
│                                      │                     │
│                                      ▼                     │
│                    ┌─────────────────────────────────────┐ │
│                    │       Firestore에 메시지 저장       │ │
│                    │ db.collection("chatRooms")         │ │
│                    │   .document(chatRoomId)            │ │
│                    │   .collection("messages")          │ │
│                    │   .add(messageData)                │ │
│                    └─────────────────┬───────────────────┘ │
│                                      │                     │
│                                      ▼                     │
│                    ┌─────────────────────────────────────┐ │
│                    │        저장 성공 시                 │ │
│                    │ updateChatRoomLastMessage()        │ │
│                    │ (채팅방의 lastMessage 업데이트)     │ │
│                    └─────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.3 실시간 메시지 수신 NS 차트

```
┌─────────────────────────────────────────────────────────────┐
│                   listenForMessages()                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              chatRoomId가 null인가?                  │   │
│  └───────────────────────┬─────────────────────────────┘   │
│           ┌──────────────┴──────────────┐                  │
│           │ YES                         │ NO               │
│           ▼                             ▼                  │
│  ┌─────────────────┐    ┌───────────────────────────────┐  │
│  │ return (종료)   │    │   실시간 리스너 등록           │  │
│  └─────────────────┘    │                               │  │
│                         │ db.collection("chatRooms")   │  │
│                         │   .document(chatRoomId)      │  │
│                         │   .collection("messages")    │  │
│                         │   .orderBy("timestamp", ASC) │  │
│                         │   .addSnapshotListener(...)  │  │
│                         └───────────────┬───────────────┘  │
│                                         │                  │
│                                         ▼                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              [리스너 콜백 - 데이터 변경 시 실행]      │  │
│  │                                                      │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │         error가 있거나 snapshots가 null인가?    │ │  │
│  │  └──────────────────────┬─────────────────────────┘ │  │
│  │           ┌─────────────┴─────────────┐             │  │
│  │           │ YES                       │ NO          │  │
│  │           ▼                           ▼             │  │
│  │  ┌─────────────────┐    ┌─────────────────────────┐ │  │
│  │  │ return (무시)   │    │   메시지 목록 생성       │ │  │
│  │  └─────────────────┘    │                         │ │  │
│  │                         │ List<ChatMessage> msgs  │ │  │
│  │                         │ = new ArrayList<>()     │ │  │
│  │                         └────────────┬────────────┘ │  │
│  │                                      │              │  │
│  │                                      ▼              │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │          각 문서에 대해 반복                    │ │  │
│  │  │  ┌──────────────────────────────────────────┐ │ │  │
│  │  │  │ ChatMessage msg = doc.toObject(...)     │ │ │  │
│  │  │  │ msg.setMessageId(doc.getId())           │ │ │  │
│  │  │  │ messages.add(msg)                       │ │ │  │
│  │  │  └──────────────────────────────────────────┘ │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  │                                      │              │  │
│  │                                      ▼              │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │           UI 업데이트                          │ │  │
│  │  │  adapter.setMessages(messages)                │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  │                                      │              │  │
│  │                                      ▼              │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │       메시지가 있으면 스크롤                    │ │  │
│  │  │  if (!messages.isEmpty())                     │ │  │
│  │  │    rvMessages.scrollToPosition(size - 1)      │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  │                                                      │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 부록: 자주 묻는 질문 (FAQ)

### Q1: timestamp를 왜 밀리초(long)로 저장하나요?

| 이유 | 설명 |
|------|------|
| 정렬 용이 | 숫자 비교만으로 시간순 정렬 가능 |
| 시간대 독립 | UTC 기준이라 전 세계 어디서나 동일 |
| 저장 효율 | 8바이트로 시간 표현 가능 |
| 계산 편의 | 두 시간의 차이 = 단순 뺄셈 |

```java
// 예시: "3분 전" 계산
long now = System.currentTimeMillis();
long msgTime = message.getTimestamp();
long diffMinutes = (now - msgTime) / 1000 / 60;
// diffMinutes = 3 → "3분 전"
```

### Q2: UUID는 어떻게 생성하고 왜 사용하나요?

```java
// UUID 생성
String chatRoomId = UUID.randomUUID().toString();
// 결과: "550e8400-e29b-41d4-a716-446655440000"
```

| 장점 | 설명 |
|------|------|
| 유일성 | 전 세계적으로 충돌 가능성 거의 0% |
| 무작위성 | 예측 불가능하여 보안에 유리 |
| 서버 불필요 | 클라이언트에서 직접 생성 가능 |

### Q3: 싱글톤 패턴이 뭔가요?

```
┌─────────────────────────────────────────────────────────────┐
│                   싱글톤 패턴 개념                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  목적: 앱 전체에서 단 하나의 인스턴스만 사용                 │
│                                                             │
│  ❌ 싱글톤 없이:                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Activity A: FirebaseManager managerA = new Firebase │   │
│  │ Activity B: FirebaseManager managerB = new Firebase │   │
│  │ Activity C: FirebaseManager managerC = new Firebase │   │
│  │                                                     │   │
│  │ 문제: 3개의 서로 다른 인스턴스 → 리소스 낭비        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ✓ 싱글톤 사용:                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Activity A: FirebaseManager.getInstance() ──┐       │   │
│  │ Activity B: FirebaseManager.getInstance() ──┼→ 동일 │   │
│  │ Activity C: FirebaseManager.getInstance() ──┘  인스턴스│   │
│  │                                                     │   │
│  │ 장점: 하나의 인스턴스 공유 → 효율적                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Q4: 콜백(Callback)이 뭔가요?

```java
/**
 * 콜백 = "나중에 결과가 나오면 이 함수를 호출해줘"
 *
 * 비유: 음식점에서 진동벨 받기
 * - 주문 (요청) → 진동벨 받음 (콜백 등록)
 * - 음식 준비됨 → 진동벨 울림 (콜백 호출)
 */

// 콜백 인터페이스 정의
public interface ChatRoomCallback {
    void onSuccess(ChatRoom chatRoom);  // 성공 시 호출
    void onFailure(Exception e);        // 실패 시 호출
}

// 사용 예시
firebaseManager.createOrGetChatRoom(partnerId,
    new ChatRoomCallback() {
        @Override
        public void onSuccess(ChatRoom chatRoom) {
            // 채팅방 생성 성공! 여기서 UI 업데이트
            openChatDetail(chatRoom);
        }

        @Override
        public void onFailure(Exception e) {
            // 실패! 에러 메시지 표시
            Toast.makeText(context, "실패: " + e.getMessage(), ...).show();
        }
    }
);
```

---

## 학습 체크리스트

- [ ] Firestore 컬렉션/문서/서브컬렉션 구조 이해
- [ ] arrayContains 쿼리 사용법 이해
- [ ] 실시간 리스너(addSnapshotListener) 개념 이해
- [ ] 리스너 생명주기 관리 (등록/해제) 이해
- [ ] RecyclerView + Adapter 패턴 이해
- [ ] ViewHolder 패턴 이해
- [ ] 콜백(Callback) 패턴 이해
- [ ] 싱글톤(Singleton) 패턴 이해
- [ ] 비동기 프로그래밍 개념 이해
- [ ] timestamp (Unix time) 개념 이해

---

## 참고 자료

1. [Firebase Firestore 공식 문서](https://firebase.google.com/docs/firestore)
2. [Firebase 실시간 리스너](https://firebase.google.com/docs/firestore/query-data/listen)
3. [Android RecyclerView 가이드](https://developer.android.com/guide/topics/ui/layout/recyclerview)
4. [Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging)

---

*이 문서는 ClubManagement 앱의 채팅 기능을 기반으로 작성되었습니다.*
*작성일: 2025년 12월*
*버전: 2.0*
